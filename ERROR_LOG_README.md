# 错误日志系统使用说明

## 简介

系统已集成轻量级错误日志功能，自动记录所有错误、警告和关键操作信息到文件。

## 功能特点

✅ **自动记录** - 无需手动调用，系统自动记录所有错误
✅ **轻量级** - 不影响系统性能，简洁高效
✅ **详细信息** - 包含时间戳、机器人名称、错误详情
✅ **异常追踪** - 自动记录完整的异常堆栈信息

## 日志文件位置

```
logs/
└── error_log_20251031_143025.txt
```

日志文件命名格式：`error_log_年月日_时分秒.txt`

## 自动记录的内容

### 1. 连接事件
- ✅ 连接成功（包含重试次数）
- ❌ 连接失败（DNS、TCP、WebSocket各层级）
- ⚠️ 连接断开检测
- 🔄 自动重连尝试

### 2. 请求事件
- ✅ 请求成功
- ❌ 请求失败
- ⏱️ 超时错误
- 🔌 连接关闭错误

### 3. 系统事件
- 🚀 系统启动/停止
- 🔄 流程执行开始/完成
- ⚠️ 用户中断
- ❌ 异常发生

## 日志格式示例

```
================================================================================
机器人控制系统错误日志
启动时间: 2025-10-31 14:30:25
================================================================================

[2025-10-31 14:30:25] [INFO] 系统: 机器人控制系统启动
--------------------------------------------------------------------------------
[2025-10-31 14:30:26] [INFO] Robot A: 连接成功 - 192.168.217.100:9091
--------------------------------------------------------------------------------
[2025-10-31 14:30:30] [ERROR] Robot B: 连接失败 - 192.168.217.80:9090 - 原因: 连接被拒绝 - 端口 9090 上没有服务监听
--------------------------------------------------------------------------------
[2025-10-31 14:30:35] [INFO] Robot A: 请求成功 - service=/control_service, action=move
--------------------------------------------------------------------------------
[2025-10-31 14:30:40] [ERROR] Robot A: 读取超时（120秒）
--------------------------------------------------------------------------------
[2025-10-31 14:30:45] [ERROR] Robot A: 操作异常 - 发送请求
异常详情:
Traceback (most recent call last):
  File "/home/zhangziwei/Code/robot_connect/robot_controller.py", line 269, in send_service_request
    result = future.result(maxtime)
  ...
--------------------------------------------------------------------------------
```

## 如何使用

### 1. 正常使用（无需改动）

只需正常运行程序，日志会自动记录：

```bash
python main.py
```

程序启动时会显示日志文件路径：
```
日志文件: logs/error_log_20251031_143025.txt
```

### 2. 查看日志

#### 实时查看
```bash
# 实时跟踪日志
tail -f logs/error_log_*.txt

# 查看最后50行
tail -n 50 logs/error_log_*.txt
```

#### 搜索特定内容
```bash
# 查看所有错误
grep "ERROR" logs/error_log_*.txt

# 查看特定机器人的日志
grep "Robot A" logs/error_log_*.txt

# 查看连接失败的记录
grep "连接失败" logs/error_log_*.txt
```

#### 按时间查看
```bash
# 查看下午2点到3点的日志
grep "14:[0-5][0-9]" logs/error_log_*.txt
```

### 3. 日志管理

#### 查看所有日志文件
```bash
ls -lh logs/
```

#### 清理旧日志
```bash
# 删除7天前的日志
find logs/ -name "error_log_*.txt" -mtime +7 -delete

# 删除所有日志
rm -f logs/*.txt
```

#### 归档日志
```bash
# 压缩归档
tar -czf logs_archive_$(date +%Y%m%d).tar.gz logs/
```

## 在代码中添加自定义日志

如果需要在其他模块中记录日志：

```python
from error_logger import get_error_logger

# 获取日志记录器
logger = get_error_logger()

# 记录错误
logger.error("模块名", "发生了一个错误")

# 记录警告
logger.warning("模块名", "这是一个警告")

# 记录信息
logger.info("模块名", "这是一条信息")

# 记录异常（带堆栈信息）
try:
    # 可能出错的代码
    result = some_function()
except Exception as e:
    logger.exception_occurred("模块名", "操作描述", e)

# 记录连接失败
logger.connection_failed("机器人名", "192.168.1.100", "9091", "超时")

# 记录连接成功
logger.connection_success("机器人名", "192.168.1.100", "9091")

# 记录请求失败
logger.request_failed("机器人名", "/service", "action", "超时")

# 记录请求成功
logger.request_success("机器人名", "/service", "action")
```

## 常见问题

### Q1: 日志文件在哪里？
**A:** 在程序运行目录的 `logs/` 文件夹下，程序启动时会显示完整路径。

### Q2: 日志会占用很多空间吗？
**A:** 不会。日志只记录错误和关键信息，通常很小。可以定期清理旧日志。

### Q3: 日志会影响性能吗？
**A:** 几乎不会。日志采用异步写入方式，对性能影响极小。

### Q4: 可以关闭日志吗？
**A:** 不建议关闭。如果确实需要，可以删除 `error_logger.py` 中的导入和调用。

### Q5: 日志文件格式是什么？
**A:** 纯文本格式(.txt)，可以用任何文本编辑器打开。

### Q6: 如何只看错误不看INFO？
**A:** 使用 grep 过滤：
```bash
grep "ERROR" logs/error_log_*.txt
```

## 故障排查示例

### 场景1：机器人连接失败

```bash
# 查看连接相关的错误
grep -A 2 "连接失败" logs/error_log_*.txt
```

输出示例：
```
[2025-10-31 14:30:30] [ERROR] Robot A: 连接失败 - 192.168.217.100:9091 - 原因: 连接被拒绝 - 端口 9091 上没有服务监听
```

**解决方案**：检查机器人是否开机，IP和端口是否正确。

### 场景2：请求超时

```bash
# 查看超时错误
grep "超时" logs/error_log_*.txt
```

输出示例：
```
[2025-10-31 14:35:40] [ERROR] Robot A: 读取超时（120秒）
```

**解决方案**：检查网络连接，机器人是否正常响应。

### 场景3：异常堆栈

```bash
# 查看详细的异常信息
grep -A 20 "异常详情" logs/error_log_*.txt
```

这会显示完整的Python异常堆栈，帮助定位问题。

## 日志级别说明

- **INFO**: 正常操作记录（连接成功、请求成功等）
- **WARNING**: 警告信息（连接断开、需要重试等）
- **ERROR**: 错误信息（连接失败、请求失败、异常等）

## 最佳实践

1. **定期查看日志**：每天检查错误日志，及时发现问题
2. **保留重要日志**：出现问题时保存日志文件用于分析
3. **定期清理**：每周或每月清理旧日志文件
4. **监控错误趋势**：统计错误数量，发现系统问题

## 技术支持

如有问题，请提供：
1. 完整的错误日志文件
2. 问题发生的时间
3. 操作步骤

日志文件路径：`logs/error_log_*.txt`

