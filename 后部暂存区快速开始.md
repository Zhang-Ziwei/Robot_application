# 后部暂存区状态管理 - 快速开始

## 🚀 5分钟快速上手

### 1. 测试存储管理器功能

```bash
cd /home/zhangziwei/Code/robot_connect
python test_storage_manager.py
```

这个测试脚本会演示所有功能：
- ✅ 初始化和重置
- ✅ 更新槽位
- ✅ 查找空槽位
- ✅ 检查是否已满
- ✅ 状态保存和加载

---

### 2. 正常启动程序

```bash
python main.py
```

#### 首次启动（无历史状态）

```
======================================================================
后部暂存区状态管理
======================================================================
未检测到历史状态文件，将使用默认配置（全空）

✓ 暂存区状态已重置为全空
```

#### 再次启动（有历史状态）

```
检测到历史暂存区状态文件: storage_state.json

当前保存的暂存区状态:
------------------------------------------------------------
glass_bottle_1000: 2/4 已占用, 状态: ['bottle_001', 'bottle_002', 0, 0]
------------------------------------------------------------

是否重置暂存区状态为全空？(y/n) [默认: n]: 
```

- **直接回车 或 输入 n**：保留历史状态
- **输入 y**：清空所有暂存区

---

### 3. 查看当前状态

#### 方法1：查看状态文件

```bash
cat storage_state.json
```

#### 方法2：查看日志

```bash
tail -f logs/error_YYYYMMDD_HHMMSS.log
```

---

### 4. 手动清空暂存区

```bash
rm storage_state.json
python main.py
# 程序会自动使用默认配置（全空）
```

---

## 📋 核心概念

### 默认配置（在 constants.py 中）

```python
DEFAULT_BACK_TEMP_STORAGE = {
    "glass_bottle_1000": [0, 0, 0, 0],  # 4个槽位
    "glass_bottle_500": [0, 0, 0, 0],   # 4个槽位  
    "glass_bottle_250": [0, 0, 0, 0]    # 4个槽位
}
```

### 状态文件（storage_state.json）

```json
{
    "glass_bottle_1000": ["bottle_001", "bottle_002", 0, 0],
    "glass_bottle_500": [0, 0, 0, 0],
    "glass_bottle_250": [0, 0, 0, 0]
}
```

- **0** = 空槽位
- **字符串** = 瓶子ID

---

## 💡 常见场景

### 场景1：程序异常退出，担心数据丢失

✅ **不用担心！** 每次放置瓶子时都会自动保存，状态不会丢失。

```bash
# 重新启动
python main.py
# 选择 'n' 保留历史状态
```

---

### 场景2：换班/重新开始，需要清空暂存区

```bash
# 启动程序
python main.py

# 看到询问时输入 'y'
是否重置暂存区状态为全空？(y/n) [默认: n]: y
```

---

### 场景3：想查看历史记录

```bash
# 查看状态文件
cat storage_state.json | python -m json.tool

# 或查看日志
grep "暂存区" logs/*.log
```

---

### 场景4：手动编辑状态文件

```bash
# 编辑状态文件
vim storage_state.json

# 修改示例：
{
    "glass_bottle_1000": ["bottle_001", 0, 0, 0],
    "glass_bottle_500": [0, 0, 0, 0],
    "glass_bottle_250": [0, 0, 0, 0]
}

# 保存后重启程序
python main.py
# 选择 'n' 保留修改
```

---

## 🔍 在代码中使用

### 基本使用

```python
from storage_manager import get_storage_manager

# 获取管理器
storage_mgr = get_storage_manager()

# 查找空槽位
empty_index = storage_mgr.get_empty_slot_index("glass_bottle_1000")

# 放置瓶子（自动保存）
storage_mgr.update_slot("glass_bottle_1000", empty_index, "bottle_001")

# 检查是否已满
if storage_mgr.is_full():
    print("暂存区已满")
```

---

## 📊 程序退出时的输出

```
======================================================================
最终暂存区状态:
======================================================================
当前暂存区状态:
============================================================
glass_bottle_1000:
  占用: 2/4
  状态: ['glass_bottle_1000_001', 'glass_bottle_1000_002', 0, 0]
...
============================================================

✓ 状态已保存到: storage_state.json
```

---

## ⚡ 快捷命令

```bash
# 查看状态
cat storage_state.json

# 备份状态
cp storage_state.json storage_state_backup.json

# 清空状态
rm storage_state.json

# 测试功能
python test_storage_manager.py

# 查看日志
tail -f logs/*.log
```

---

## 🎯 关键特性

| 特性 | 说明 |
|------|------|
| ✅ 自动持久化 | 每次修改都会立即保存到文件 |
| ✅ 启动时选择 | 可选择恢复历史状态或清空 |
| ✅ 实时同步 | 状态文件与内存实时同步 |
| ✅ 日志记录 | 所有操作都有日志记录 |
| ✅ 简单易用 | 提供便捷的 API 接口 |

---

## 📞 需要帮助？

查看完整文档：`后部暂存区状态管理说明.md`

---

**开始使用吧！** 🚀

