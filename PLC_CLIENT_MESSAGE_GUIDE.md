# PLC 客户端消息监控使用指南

## 功能说明

现在 `plc_modbus.py` 已经添加了完整的客户端消息监控功能，可以实时显示从 PLC 客户端接收到的所有数据变化。

## 新增功能

### 1. 客户端消息实时显示

程序会自动监控并显示：
- ✅ **线圈变化**：当PLC客户端修改线圈状态时显示
- ✅ **保持寄存器变化**：当PLC客户端修改保持寄存器时显示
- ✅ **本地写入区分**：区分本地程序写入和客户端写入

### 2. 消息格式

**客户端写入消息：**
```
📩 PLC客户端消息: 开盖模块状态 (寄存器 0) 改变: 0 → 1
📩 PLC客户端消息: 线圈 0 (Coil 1) 改变: False → True
```

**本地写入消息：**
```
📤 PLC本地写入: 线圈 0 (Coil 1) 设置为 True
```

### 3. 寄存器友好名称映射

程序会自动将寄存器索引转换为友好名称：
- 寄存器 0 → "开盖模块状态"
- 寄存器 1 → "清洗模块状态"
- 寄存器 2 → "检测模块状态"
- 寄存器 3 → "关盖模块状态"

## 测试方法

### 方法一：本地模拟测试（无需真实PLC）

1. **启动PLC服务器：**
   ```bash
   cd /home/zhangziwei/Code/robot_connect
   source ~/anaconda3/etc/profile.d/conda.sh
   conda activate robot_connect
   python main.py
   ```

2. **在另一个终端运行模拟客户端：**
   ```bash
   cd /home/zhangziwei/Code/robot_connect
   source ~/anaconda3/etc/profile.d/conda.sh
   conda activate robot_connect
   python test_plc_client_simulation.py
   ```

3. **观察服务器输出**
   
   服务器端会显示所有客户端的消息变化：
   ```
   ╔════════════════════════════════════════════════╗
   ║   Modbus TCP Server started on 0.0.0.0:1502   ║
   ║   等待PLC客户端连接...                         ║
   ║   客户端消息变化将实时显示                     ║
   ╚════════════════════════════════════════════════╝
   PLC: Auto-reset coils thread started
   PLC: Monitoring client messages...
   
   📩 PLC客户端消息: 线圈 0 (Coil 1) 改变: False → True
   📩 PLC客户端消息: 开盖模块状态 (寄存器 0) 改变: 0 → 1
   📩 PLC客户端消息: 开盖模块状态 (寄存器 0) 改变: 1 → 2
   ```

### 方法二：使用真实PLC客户端测试

1. **启动PLC服务器**（如上）

2. **配置您的PLC设备连接到：**
   - IP地址：服务器的IP
   - 端口：1502（或您配置的端口）
   - 从机ID：1

3. **从PLC设备写入数据**
   - 写入线圈 0-15
   - 写入保持寄存器 0-3

4. **观察服务器实时显示的消息**

## 数据流程

```
PLC客户端设备
    ↓ (写入数据)
Modbus TCP 网络
    ↓
PLC服务器 (plc_modbus.py)
    ↓ (每100ms检测)
发现数据变化
    ↓
📩 显示客户端消息
    ↓
执行业务逻辑（自动复位等）
```

## 监控的数据项

### 线圈 (Coils) - 16个
- 线圈 0 (Coil 1)：开盖启动
- 线圈 1 (Coil 2)：开盖完成后取瓶
- 线圈 2 (Coil 3)：关盖启动
- 线圈 3 (Coil 4)：关盖完成后取瓶
- 线圈 4 (Coil 5)：检测放料位移
- 线圈 5 (Coil 6)：检测启动
- 线圈 6 (Coil 7)：检测取料位移
- 线圈 7 (Coil 8)：检测取料完成
- 线圈 8 (Coil 9)：清洗启动
- 线圈 9 (Coil 10)：清洗取料完成
- 线圈 10-15：保留

### 保持寄存器 (Holding Registers) - 4个
- 寄存器 0：开盖模块状态 (0-未就绪, 1-准备就绪, 2-工作中, 3-工作完成)
- 寄存器 1：清洗模块状态 (0-未就绪, 1-准备就绪, 2-工作中, 3-工作完成)
- 寄存器 2：检测模块状态 (0-未就绪, 1-准备就绪, 2-放料位移完成, 3-工作中, 4-请求取走第一个样品, 5-请求取走第二个样品)
- 寄存器 3：关盖模块状态 (0-未就绪, 1-准备就绪, 2-工作中, 3-工作完成)

## 故障排除

### 问题1：看不到客户端消息
**原因**：客户端可能没有连接或没有写入数据
**解决**：
1. 检查客户端是否成功连接
2. 使用 `test_plc_client_simulation.py` 验证功能
3. 检查防火墙是否阻止连接

### 问题2：消息显示混乱
**原因**：多个客户端同时连接
**解决**：确保同一时间只有一个客户端连接

### 问题3：数据变化但没有显示
**原因**：监控线程可能出错
**解决**：查看是否有错误日志输出

## 代码修改说明

如需修改监控行为，编辑 `plc_modbus.py`：

1. **修改检测频率**（第 209 行）：
   ```python
   time.sleep(0.1)  # 100ms检查一次，可以调整
   ```

2. **添加更多寄存器名称**（第 29-37 行）：
   ```python
   def _get_register_name(self, reg_idx):
       register_names = {
           # 在这里添加更多映射
       }
   ```

3. **自定义消息格式**（第 113、127 行）：
   修改 print 语句中的格式

## 总结

现在您的 PLC 服务器具备完整的消息监控功能：
- ✅ 实时显示所有客户端数据变化
- ✅ 区分本地写入和客户端写入
- ✅ 友好的消息格式和名称
- ✅ 完整的测试工具

测试时观察控制台输出，您将看到所有 PLC 客户端的消息！

