# 错误日志功能实现说明

## 更新时间
2025年10月31日

## 概述
实现了轻量级错误日志系统，自动记录系统运行中的所有错误、警告和关键操作信息。

## 新增文件

### 1. `error_logger.py` - 核心日志模块
**功能**：
- 单例模式的日志记录器
- 自动创建日志目录和文件
- 提供多种便捷的日志记录方法

**主要方法**：
```python
logger.error(robot_name, message)          # 记录错误
logger.warning(robot_name, message)        # 记录警告
logger.info(robot_name, message)           # 记录信息
logger.connection_failed(...)              # 记录连接失败
logger.connection_success(...)             # 记录连接成功
logger.request_failed(...)                 # 记录请求失败
logger.request_success(...)                # 记录请求成功
logger.exception_occurred(...)             # 记录异常（含堆栈）
```

### 2. `ERROR_LOG_README.md` - 使用文档
完整的使用说明，包括：
- 功能介绍
- 日志格式
- 查看方法
- 故障排查
- 最佳实践

### 3. `test_error_log.py` - 测试脚本
用于验证日志功能是否正常工作

## 修改的文件

### 1. `robot_controller.py`

#### 导入日志模块
```python
from error_logger import get_error_logger
```

#### 添加日志记录点

**连接管理**：
- ✅ 连接成功（第80-84行）
- ❌ 连接失败 - 达到最大重试次数（第44-46行）
- ❌ DNS解析失败（第117-119行）
- ❌ TCP连接超时（第132-134行）
- ❌ TCP连接被拒绝（第140-142行）
- ❌ TCP连接其他错误（第148-150行）
- ❌ WebSocket连接失败（第189-191行）

**请求管理**：
- ⚠️ 发送前连接断开（第204行）
- ❌ 重连失败（第207行）
- ✅ 请求成功（第274行）
- ❌ 请求失败（第276行）
- ❌ 通信异常（第283行）

**异步通信**：
- ❌ 读取超时（第353行）
- ❌ WebSocket连接关闭（第359行）
- ❌ 异步通信错误（第365行）

### 2. `main.py`

#### 导入日志模块
```python
from error_logger import get_error_logger
```

#### 添加日志记录

**系统启动**（第11-13行）：
```python
logger = get_error_logger()
logger.info("系统", "机器人控制系统启动")
print(f"日志文件: {logger.get_log_file()}")
```

**主循环**（第51-73行）：
- 流程开始/完成记录
- 异常捕获和记录
- 用户中断记录
- 系统停止记录

## 日志文件结构

```
logs/
└── error_log_20251031_143025.txt
```

### 日志格式
```
[时间戳] [级别] 机器人名称: 消息内容
--------------------------------------------------------------------------------
```

### 示例日志
```
[2025-10-31 14:30:25] [INFO] 系统: 机器人控制系统启动
--------------------------------------------------------------------------------
[2025-10-31 14:30:26] [INFO] Robot A: 连接成功 - 192.168.217.100:9091
--------------------------------------------------------------------------------
[2025-10-31 14:30:30] [ERROR] Robot B: 连接失败 - 192.168.217.80:9090 - 原因: 连接被拒绝
--------------------------------------------------------------------------------
[2025-10-31 14:30:35] [ERROR] Robot A: 操作异常 - 发送请求
异常详情:
Traceback (most recent call last):
  ...
--------------------------------------------------------------------------------
```

## 使用方法

### 正常使用
无需任何额外操作，运行程序即可：
```bash
python main.py
```

程序启动时会显示：
```
日志文件: logs/error_log_20251031_143025.txt
```

### 查看日志
```bash
# 实时查看
tail -f logs/error_log_*.txt

# 查看所有错误
grep "ERROR" logs/error_log_*.txt

# 查看特定机器人
grep "Robot A" logs/error_log_*.txt
```

### 测试日志功能
```bash
python test_error_log.py
```

## 设计特点

### 1. 轻量级
- 单文件实现，代码简洁
- 只记录必要信息
- 性能影响极小

### 2. 自动化
- 自动创建日志目录
- 自动生成日志文件
- 无需手动配置

### 3. 易用性
- 简单的API接口
- 清晰的日志格式
- 便于查看和分析

### 4. 完整性
- 记录所有关键错误
- 包含异常堆栈信息
- 时间戳精确到秒

## 记录的事件类型

### INFO（信息）
- 系统启动/停止
- 连接成功
- 请求成功
- 流程开始/完成

### WARNING（警告）
- 连接断开检测
- 需要重连

### ERROR（错误）
- 连接失败（各种原因）
- 请求失败
- 超时错误
- 异常发生（含堆栈）

## 优势对比

### 相比之前的方案
| 特性 | 之前的方案 | 当前方案 |
|------|-----------|----------|
| 复杂度 | 高（多文件、配置复杂） | 低（单文件、零配置） |
| 代码侵入 | 高（大量修改） | 低（最小化修改） |
| 性能影响 | 中等 | 极小 |
| 易用性 | 需要学习 | 开箱即用 |
| 文件大小 | 较大（轮转、备份） | 小巧 |

## 未来扩展

如需更多功能，可以轻松扩展：

### 1. 添加日志级别过滤
```python
def _write_log(self, level, robot_name, message, exc=None):
    # 只记录ERROR级别
    if level != "ERROR":
        return
    # ... 现有代码
```

### 2. 添加日志轮转
```python
def _write_log(self, level, robot_name, message, exc=None):
    # 检查文件大小
    if os.path.getsize(self._log_file) > 10*1024*1024:  # 10MB
        self._rotate_log()
    # ... 现有代码
```

### 3. 添加远程日志上传
```python
def _write_log(self, level, robot_name, message, exc=None):
    # ... 写入本地
    if level == "ERROR":
        self._send_to_server(message)
```

## 注意事项

1. **日志文件管理**
   - 定期清理旧日志（建议保留最近7天）
   - 重要日志及时备份

2. **性能考虑**
   - 日志为同步写入，但对性能影响极小
   - 避免在高频循环中添加过多日志

3. **隐私安全**
   - 不要记录敏感信息（密码、密钥等）
   - 日志文件权限要适当设置

4. **Git管理**
   - 日志目录已加入.gitignore
   - 不会提交到版本控制

## 故障排查

### 问题1：找不到日志文件
**检查**：
1. 程序是否正常启动
2. 是否有写入权限
3. 日志目录是否存在

### 问题2：日志内容不完整
**检查**：
1. 程序是否异常退出
2. 是否有磁盘空间
3. 是否有文件写入权限

### 问题3：日志文件过大
**解决**：
1. 定期清理旧日志
2. 提高日志级别
3. 实现日志轮转

## 总结

✅ 实现了完整的错误日志功能
✅ 代码简洁，易于维护
✅ 自动化程度高，无需配置
✅ 记录全面，便于问题排查
✅ 性能影响小，不影响正常运行

日志系统现已完全集成到代码中，可以有效帮助：
- 追踪系统运行状态
- 快速定位错误原因
- 分析系统稳定性
- 提供技术支持依据

