# 自动重连功能更新说明

## 更新日期
2025年10月21日

## 概述
为 `RobotController` 类添加了完整的自动重连机制，使系统在网络不稳定或机器人临时断线的情况下更加健壮。

## 主要改动

### 1. robot_controller.py

#### 新增初始化参数
- `max_retry_attempts`: 最大重试次数（None=无限重试）
- `retry_interval`: 重试间隔（秒）
- `retry_count`: 当前重试计数器

#### 改进的 `connect()` 方法
**改动前：**
- 连接失败直接返回 False
- 没有重试机制

**改动后：**
- 支持自动重试，可配置重试次数和间隔
- 显示详细的重试进度信息
- 每次重试前清理旧连接
- 连接成功后重置重试计数器

#### 改进的 `send_service_request()` 方法
**改动前：**
- 发现连接断开时只尝试一次重连
- 重连逻辑简单

**改动后：**
- 发送前自动检查连接状态
- 发现断开立即尝试重连
- 对多种异常情况进行检查和自动恢复
- 更详细的错误信息输出

#### 改进的 `_async_send_and_receive()` 方法
**改动前：**
- 异常时不标记连接状态
- 错误信息简单

**改动后：**
- 超时、连接关闭等异常时自动标记 `connected=False`
- 区分不同类型的异常（超时、连接关闭、其他错误）
- 更清晰的错误信息输出

### 2. main.py

#### 更新机器人初始化代码
**改动前：**
```python
robot_a = RobotController("192.168.217.100", "9091", RobotType.ROBOT_A)
robot_b = RobotController("192.168.217.80", "9090", RobotType.ROBOT_B)
```

**改动后：**
```python
robot_a = RobotController(
    "192.168.217.100", 
    "9091", 
    RobotType.ROBOT_A,
    max_retry_attempts=None,  # 无限重试
    retry_interval=5          # 每5秒重试
)

robot_b = RobotController(
    "192.168.217.80", 
    "9090", 
    RobotType.ROBOT_B,
    max_retry_attempts=None,
    retry_interval=5
)
```

### 3. 新增文件

#### RECONNECTION_GUIDE.md
- 详细的使用指南
- 配置参数说明
- 多种使用场景示例
- 常见问题解答
- 最佳实践建议

#### test_reconnection.py
- 自动重连功能测试脚本
- 包含4种测试场景：
  1. 无限重试模式
  2. 有限重试模式
  3. 连接断开后自动重连
  4. 快速重试模式
- 交互式选择测试

## 新功能特性

### ✨ 自动重连
- 初始连接失败时自动重试
- 连接中断时自动恢复
- 发送请求失败时自动重连

### 🔧 灵活配置
- 可设置无限重试或有限次数重试
- 可自定义重试间隔
- 兼容旧代码（新参数都有默认值）

### 📊 详细日志
- 显示重试进度（如：重试 2/10 或 2/∞）
- 网络诊断信息（TCP连接、DNS解析等）
- 清晰的成功/失败标记（✓ ✗ ⚠ ⏳）

### 🛡️ 异常处理
- 区分不同类型的网络异常
- 超时自动标记为断开
- WebSocket连接关闭自动重连

## 向后兼容性

✅ **完全向后兼容**

旧代码无需修改即可运行：
```python
# 这样的旧代码仍然有效
robot = RobotController("192.168.217.100", "9091", RobotType.ROBOT_A)
```

默认行为：
- `max_retry_attempts = None`（无限重试）
- `retry_interval = 5`（5秒间隔）

## 使用示例

### 快速开始（推荐配置）

```python
from robot_controller import RobotController
from constants import RobotType

# 生产环境：无限重试
robot = RobotController(
    "192.168.217.100",
    "9091",
    RobotType.ROBOT_A,
    max_retry_attempts=None,  # 无限重试
    retry_interval=5          # 每5秒重试
)

# 连接会自动重试直到成功
robot.connect()

# 发送请求，连接断开会自动重连
robot.send_service_request("/service", "action")
```

### 测试环境配置

```python
# 测试环境：有限重试
robot = RobotController(
    "192.168.217.100",
    "9091",
    RobotType.ROBOT_A,
    max_retry_attempts=5,  # 最多5次
    retry_interval=2       # 每2秒重试
)

if not robot.connect():
    print("连接失败，请检查机器人状态")
```

## 测试方法

### 运行测试脚本
```bash
python test_reconnection.py
```

### 手动测试场景

1. **测试初始连接重试**
   - 先不启动机器人
   - 运行程序，观察重试过程
   - 启动机器人，观察自动连接成功

2. **测试运行时断开重连**
   - 启动程序并连接成功
   - 断开机器人电源或网络
   - 发送请求，观察重连过程
   - 恢复机器人连接，观察自动恢复

3. **测试有限重试**
   - 设置 `max_retry_attempts=3`
   - 不启动机器人
   - 观察3次重试后停止

## 预期输出示例

```
============================================================
正在连接 Robot A (192.168.217.100:9091)...
重试策略：无限重试，间隔 5 秒
============================================================

=== Robot A 网络诊断 ===
目标地址: 192.168.217.100:9091
✓ DNS 解析成功: 192.168.217.100 -> 192.168.217.100
正在测试 TCP 连接到 192.168.217.100:9091...
✗ 连接被拒绝 - 端口 9091 上没有服务监听
✗ Robot A 连接失败
⏳ 等待 5 秒后重试...

[重试 2/∞] 尝试连接 Robot A...
=== Robot A 网络诊断 ===
目标地址: 192.168.217.100:9091
✓ DNS 解析成功: 192.168.217.100 -> 192.168.217.100
正在测试 TCP 连接到 192.168.217.100:9091...
✓ TCP 连接成功
正在建立 WebSocket 连接...
✓ WebSocket 连接成功 (使用 rosbridge_v2 协议)
✓ Robot A 已成功连接到 192.168.217.100:9091
✓ Robot A 连接成功！
```

## 注意事项

1. **无限重试模式**会持续尝试连接，使用 Ctrl+C 中断
2. 重试间隔不建议太短（<1秒），避免过度占用网络资源
3. 生产环境建议使用无限重试，确保系统稳定性
4. 测试环境可以使用有限重试，快速发现问题

## 后续优化建议

- [ ] 添加指数退避策略（重试间隔逐渐增加）
- [ ] 添加连接状态回调函数
- [ ] 添加重连事件日志记录
- [ ] 支持多个IP地址自动切换（高可用）

## 问题反馈

如有问题，请查看 `RECONNECTION_GUIDE.md` 中的常见问题部分。

