# 模拟测试快速开始

## 🚀 1分钟开始测试（无需机器人）

### 步骤1：启动模拟测试

```bash
python test_mock_mode.py
```
8080端口可能会被占用
使用sudo netstat -tulpn | grep 8080 或在 sudo netstat -tulpn | grep 8080查看占用端口
如果找到进程，用 sudo kill -9 <PID> 关闭。

### 步骤2：选择交互式测试（推荐）

```
选择测试模式:
  1. 交互式测试（推荐）- 菜单操作，方便测试
  2. 等待模式 - 等待外部curl命令

请选择模式 (1/2) [默认: 1]: 1
```

直接按 Enter 或输入 `1`

### 步骤3：使用交互菜单

```
请选择操作:
  1. 发送BOTTLE_GET命令（查询瓶子）
  2. 发送PICK_UP命令（拾取瓶子）
  3. 发送PUT_TO命令（放置瓶子）
  4. 快速发送3个测试命令
  5. 查询队列状态
  6. 查询所有任务状态
  7. 监控任务执行（实时）
  0. 退出测试

输入选项 [0-7]: 
```

**推荐测试流程**：
1. 输入 `4` - 快速发送3个测试命令
2. 输入 `7` - 实时监控任务执行
3. 观看任务自动排队执行

---

## 💡 快速体验任务队列

### 一键测试

启动后，按以下顺序操作：

```
1. 输入 4 ← 快速发送3个命令
   （会看到任务加入队列）

2. 输入 5 ← 查看队列状态
   （会看到任务数量和执行情况）

3. 输入 7 ← 实时监控
   （自动刷新，看任务一个个完成）
```

### 你会看到

**发送命令时**：
```
📤 发送命令: BOTTLE_GET
  ✓ 任务已提交
    任务ID: TASK_000001
    队列位置: 1

📤 发送命令: PICK_UP
  ✓ 任务已提交
    任务ID: TASK_000002
    队列位置: 2
```

**监控执行时**：
```
⏳ TASK_000001 (BOTTLE_GET): 等待中...
----------------------------------------------------------------------
▶️  TASK_000001 (BOTTLE_GET): 执行中...
⏳ TASK_000002 (PICK_UP): 等待中...
----------------------------------------------------------------------
✅ TASK_000001 (BOTTLE_GET): 完成 (耗时: 1.2秒)
▶️  TASK_000002 (PICK_UP): 执行中...
----------------------------------------------------------------------
✅ TASK_000001 (BOTTLE_GET): 完成 (耗时: 1.2秒)
✅ TASK_000002 (PICK_UP): 完成 (耗时: 12.5秒)

✅ 所有任务执行完成！
```

---

## 🎮 交互式功能说明

### 选项1-3：发送单个命令
- 立即发送指定类型的命令
- 返回task_id用于后续查询

### 选项4：快速发送3个测试命令
- 自动发送BOTTLE_GET、PICK_UP、PUT_TO
- 展示任务队列的排队效果

### 选项5：查询队列状态
```
📊 队列状态:
  运行中: True
  队列长度: 2
  当前任务: TASK_000001
  总任务数: 3

任务统计:
  ⏳ 等待中: 2
  ▶️  执行中: 1
  ✅ 已完成: 0
  ❌ 失败: 0
```

### 选项6：查询所有任务状态
```
📋 所有任务状态（共 3 个）:
----------------------------------------------------------------------
✅ TASK_000001 (BOTTLE_GET): 完成 (1.2秒)
▶️  TASK_000002 (PICK_UP): 执行中
⏳ TASK_000003 (PUT_TO): 等待中
----------------------------------------------------------------------
```

### 选项7：实时监控
- 每2秒自动刷新
- 显示所有任务的最新状态
- 自动检测全部完成
- 按 Ctrl+C 返回主菜单

---

## 📋 任务队列特性

### ✅ 自动排队
- 多个命令自动加入队列
- HTTP立即返回task_id
- 不会阻塞客户端

### ✅ 顺序执行
- 一个任务执行完成后才执行下一个
- 机器人返回result=True后继续
- 避免命令冲突

### ✅ 状态查询
- 随时查询队列状态
- 查看任务执行进度
- 实时监控功能

---

## 🔧 高级用法（等待模式）

如果选择模式2（等待模式），可以使用curl命令：

```bash
# 终端1 - 启动服务器
python test_mock_mode.py
# 选择模式 2

# 终端2 - 发送命令
curl -X POST http://localhost:8081 -d @test_commands/bottle_get_command.json

# 查询队列状态
curl http://localhost:8081/queue/status

# 查询任务状态
curl http://localhost:8081/task/TASK_000001
```

---

## 📊 命令输出示例

### 终端显示机器人命令

交互式测试时，终端会实时显示所有发送给机器人的命令：

```
──────────────────────────────────────────────────────────────────────
📤 Mock Robot (192.168.217.100:9091) - 发送请求
──────────────────────────────────────────────────────────────────────
服务: /navigation_status
动作: waiting_navigation_status

完整JSON请求:
{
  "op": "call_service",
  "service": "/navigation_status",
  "args": {
    "action": "waiting_navigation_status"
  }
}
──────────────────────────────────────────────────────────────────────
✓ 模拟执行成功
✓ 返回结果: True
──────────────────────────────────────────────────────────────────────
```

这就是**真实机器人会收到的命令**！

---

## 🆘 常见问题

### Q1: 端口被占用？

**错误**：`OSError: [Errno 98] Address already in use`

**解决**：
```bash
# 查找占用端口的进程
sudo lsof -i :8081

# 关闭进程
sudo kill -9 <PID>
```

### Q2: 交互菜单没有响应？

确保：
- 已经完全启动（看到"交互式测试模式"）
- 输入有效选项（0-7）
- 按Enter确认输入

### Q3: 监控时看不到变化？

- 任务可能执行很快
- 试试选项4发送多个命令
- PICK_UP命令执行时间较长，效果更明显

---

## 📁 生成的文件

测试完成后会生成：

```
logs/error_log_*.txt           # 系统日志
mock_robot_a_requests.json     # Robot A的所有命令
mock_robot_b_requests.json     # Robot B的所有命令
```

查看命令日志：
```bash
cat mock_robot_a_requests.json | python -m json.tool
```

---

## ✨ 为什么使用交互式测试？

### 传统方式（curl）
- ❌ 需要打开多个终端
- ❌ 需要记住命令
- ❌ 难以监控进度
- ❌ 不直观

### 交互式测试
- ✅ 单终端完成所有操作
- ✅ 菜单引导，无需记命令
- ✅ 实时监控功能
- ✅ 直观友好

---

## 🎯 推荐测试流程

### 新手测试
```
1. 启动 test_mock_mode.py
2. 选择模式 1（交互式）
3. 输入 1 发送BOTTLE_GET命令
4. 观察终端显示的机器人命令
5. 输入 0 退出
```

### 完整测试
```
1. 启动 test_mock_mode.py
2. 选择模式 1（交互式）
3. 输入 4 快速发送3个命令
4. 输入 5 查看队列状态
5. 输入 7 实时监控执行
6. 等待所有任务完成
7. 输入 6 查看最终状态
8. 输入 0 退出
```

### 压力测试
```
1. 启动后选择交互式
2. 多次输入 4（发送多批命令）
3. 输入 5 查看队列堆积情况
4. 输入 7 观察顺序执行
```

---

## 🚀 下一步

- 查看详细文档：`NEW_FUNCTION_README.md`
- 查看输出示例：`模拟测试示例输出.md`
- 真实机器人测试：`python main.py` → 选择模式1

**交互式测试让你轻松体验任务队列功能！** 🎉
